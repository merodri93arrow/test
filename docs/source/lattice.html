<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Lattice Selector Guide</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#fff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb;
  --brand:#0ea5e9; --brand-2:#0369a1; --sel:#eff6ff;
  --contentHeight:520px; --logoH:28px;
}
*{box-sizing:border-box}
body{margin:0;padding:16px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--fg);background:#fff}

/* Top bar layout: [logos] [centered title] [actions] */
.topbar{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;margin-bottom:10px}
.brand-logos{display:flex;align-items:center;gap:10px}
.logo{height:var(--logoH);width:auto;border-radius:6px;box-shadow:0 0 0 1px var(--border) inset;display:block}
.app-title{margin:0;font-size:20px;line-height:1.2;justify-self:center;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
button,.btn{border:1px solid var(--border);background:#f8fafc;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px}
button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
button.primary:hover{background:var(--brand-2)}
.pill{padding:2px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border);font-size:12px;color:var(--muted)}

/* Filters */
.filters-wrap{border:1px solid var(--border);border-radius:10px;padding:10px;overflow-x:auto;margin-bottom:10px}
.filters-grid{display:grid;grid-auto-flow:column;grid-auto-columns:minmax(180px,200px);gap:12px;padding-bottom:4px;min-height:230px}
.filter-card{border:2px solid var(--border);border-radius:12px;background:#fff;height:240px;display:flex;flex-direction:column;overflow:hidden;transition:border-color .15s,opacity .15s}
.filter-card.active{border-color:var(--brand)} .filter-card.disabled{opacity:.6}
.filter-head{padding:6px 8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:6px}
.filter-head b{font-size:12px}
.filter-head input[type=text]{width:100%;font-size:12px;padding:3px 6px;border:1px solid var(--border);border-radius:8px}
.filter-body{overflow:auto;padding:6px 8px;font-size:12px;line-height:1.2;flex:1}
.filter-body label{display:flex;align-items:center;gap:6px;padding:1px 0}
.filter-foot{padding:6px 8px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:space-between;align-items:center}

/* Bottom split */
.bottom-area{display:flex;gap:12px;align-items:flex-start}
.table-container{width:50%;min-width:420px;max-width:100%}
.table-wrap{border:1px solid var(--border);border-radius:10px;overflow:hidden}
.table-scroll{height:var(--contentHeight);overflow-y:auto}

/* Table */
table{width:100%;border-collapse:collapse;font-size:12px;background:#fff}
thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--border);text-align:center;padding:8px 6px;z-index:1}
tbody td{border-top:1px solid var(--border);text-align:center;padding:6px;white-space:nowrap}
tbody tr{cursor:pointer}
tbody tr:hover{background:#f9fafb}
tbody tr.selected{background:var(--sel)}
td.left{text-align:left !important;}
.pager{display:flex;align-items:center;gap:8px;justify-content:flex-start;margin-top:8px;font-size:12px;color:#6b7280}

/* Details */
.details-container{flex:1;min-width:260px;display:flex;flex-direction:column;gap:8px}
.details-card{border:1px solid var(--border);border-radius:10px;background:#fff;padding:10px;display:flex;flex-direction:column;height:var(--contentHeight)}
.details-head{font-weight:700;font-size:14px;margin-bottom:6px}
.details-body{flex:1;overflow-y:auto;padding-right:4px;line-height:1.4}
.details-body .row{padding:2px 0;border-bottom:1px dashed #f1f5f9}
.details-body .key{font-weight:600;color:#374151}
.details-body .val{color:#111827}
.details-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:4px}
.notice{font-size:12px;color:#6b7280}
.error{color:#b91c1c}

/* Responsive */
@media (max-width:640px){
  :root{--logoH:22px}
  .app-title{font-size:18px}
}
</style>
</head>
<body>

<!-- Top bar -->
<div class="topbar">
  <div class="brand-logos">
    <a id="logo1-link" href="#" target="_blank" rel="noopener" aria-label="Logo 1">
      <img id="logo1-img" class="logo" alt="Logo 1" />
    </a>
    <a id="logo2-link" href="#" target="_blank" rel="noopener" aria-label="Logo 2">
      <img id="logo2-img" class="logo" alt="Logo 2" />
    </a>
  </div>
  <h1 class="app-title">Lattice Selector Guide</h1>
  <div class="actions">
    <button id="btn-clear-all" class="btn" disabled>Clear all</button>
    <span class="pill" id="count-pill">0 items</span>
  </div>
</div>

<!-- Filters -->
<div class="filters-wrap">
  <div class="filters-grid" id="filters-grid"></div>
</div>

<div class="statusbar" id="active-filters"></div>

<!-- Bottom area -->
<div class="bottom-area">
  <!-- Left: table -->
  <div class="table-container">
    <div class="table-wrap">
      <div class="table-scroll">
        <table id="data-table">
          <thead><tr id="thead-row"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
    <div class="pager">
      <button id="prev" class="btn" disabled>Previous</button>
      <span id="page-info">Page 1</span>
      <button id="next" class="btn" disabled>Next</button>
      <select id="perpage" disabled>
        <option value="25">25</option>
        <option value="50" selected>50</option>
        <option value="100">100</option>
        <option value="200">200</option>
        <option value="100000">All</option>
      </select>
    </div>
  </div>

  <!-- Right: details -->
  <div class="details-container">
    <div class="details-card">
      <div class="details-head">Selected row details</div>
      <div id="details-body" class="details-body">
        <div class="row"><span class="key">Select a row to view the full details…</span></div>
      </div>
    </div>
    <div class="details-actions">
      <button id="btn-export" class="primary" disabled>Export</button>
    </div>
    <div id="auto-note" class="notice"></div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
// Excel file location (relative next to this HTML, or absolute OneDrive/SharePoint link with ?download=1)
let EXCEL_URL = "./Lattice_GUI_sharepoint_version.xlsx";
const res = await fetch(EXCEL_URL, {cache:"no-store", credentials:"include"});
(function(){ const p=new URLSearchParams(location.search); if(p.has("excel")) EXCEL_URL=p.get("excel"); })();

// Two logos (same height; widths can vary)
let LOGO1_URL  = "https://bitbucket.org/arrowesc/lattice/raw/b15f14d70f246b41b711f3234a9612d010ade8ae/sharepoint/brand_logos/Arrow_Worm_white.jpg";   // e.g. Arrow icon
let LOGO1_LINK = "https://www.arrow.com/";                // optional target when clicking logo 1
let LOGO2_URL  = "https://bitbucket.org/arrowesc/lattice/raw/b15f14d70f246b41b711f3234a9612d010ade8ae/sharepoint/brand_logos/Lattice_Logo_Black_TransparentBG.jpg";   // e.g. Lattice logo (wider)
let LOGO2_LINK = "https://www.latticesemi.com/";                // optional target when clicking logo 2

/* ============== Columns configuration ============== */
const EXPECTED_COLUMNS = ["Part Number","Family","Logic Elements","Total I/O","Pin/Balls Count","Pitch (mm)","Size (mm)","Temperature","Package Type","Max Frequency","PCIe","MIPI"];
const FILTER_COLUMNS   = ["Family","Logic Elements","Total I/O","Pin/Balls Count","Pitch (mm)","Size (mm)","Temperature","Package Type","Max Frequency","PCIe","MIPI"];
const DISPLAY_COLUMNS  = ["Part Number","Family","Logic Elements","Total I/O","Pin/Balls Count","Pitch (mm)","Size (mm)","Temperature","Package Type","Max Frequency","PCIe","MIPI"];

/* ===================== State ===================== */
let fullData=[],activeFilters={},filtered=[],page=1,perPage=50,editingColumn=null,selectedRef=null;

/* ===================== Helpers ===================== */
function canon(s){ return String(s).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g,""); }
const isNil=v=>v===null||v===undefined||(typeof v==="number"&&isNaN(v));
function norm(v){ if(isNil(v)) return ""; if(typeof v==="number") return String(v); return String(v).trim(); }
function uniqueSorted(values){ const set=new Set(values.map(norm)); const arr=[...set].filter(v=>v!==""); const asNum=arr.every(v=>/^-?\d+(\.\d+)?$/.test(v)); return arr.sort((a,b)=>asNum?(parseFloat(a)-parseFloat(b)):a.localeCompare(b)); }

function mapRowToExpected(row){
  const nmap={}; for(const k in row){ nmap[canon(k)]=k; }
  const pick=(...cands)=>{ for(const c of cands){ const t=canon(c); for(const nk in nmap){ if(nk===t||nk.includes(t)) return row[nmap[nk]]; } } return ""; };
  const o={};
  o["Part Number"]=pick("Part Number","PartNumber","Device","PN");
  o["Family"]=pick("Family");
  o["Logic Elements"]=pick("Logic Elements","LE","LUTs");
  o["Total I/O"]=pick("Total I/O","Total IO","IO Count");
  o["Pin/Balls Count"]=pick("Pin/Balls Count","Pin Count","Pins","Balls");
  o["Pitch (mm)"]=pick("Pitch (mm)","Pitch");
  o["Size (mm)"]=pick("Size (mm)","Package Size","Size");
  o["Temperature"]=pick("Temperature","Temp");
  o["Package Type"]=pick("Package Type","Package type","Package");
  o["Max Frequency"]=pick("Freq_max (MHz)","Freq max (MHz)","Fmax","Max Frequency (MHz)","Frecuencia Máxima");
  o["PCIe"]=pick("PCIe (Soft IP, Hard IP)","PCIe");
  o["MIPI"]=pick("MIPI (Soft IP, Hard IP)","MIPI");
  o["_rawOriginal"]=row;
  return o;
}

/* ===================== Data load ===================== */
async function autoFetchExcel(){
  const note=document.getElementById("auto-note");
  note.classList.remove("error");
  note.textContent="Loading data…";
  try{
    const res=await fetch(EXCEL_URL,{cache:"no-store",credentials:"include"});
    if(!res.ok) throw new Error("HTTP "+res.status+" "+res.statusText);
    const buf=await res.arrayBuffer();
    await loadFromArrayBuffer(buf);
    note.textContent="";
  }catch(err){
    note.classList.add("error");
    note.innerHTML="Auto-load failed. Check Excel URL or permissions.<br><small>Current URL: <code>"+EXCEL_URL+"</code></small>";
    console.error("Auto-load Excel failed:",err);
  }
}
async function loadFromArrayBuffer(buf){
  const wb=XLSX.read(buf,{type:"array"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const raw=XLSX.utils.sheet_to_json(ws,{defval:""});
  const data=raw.map(mapRowToExpected).filter(r=>norm(r["Part Number"])!=="");
  setData(data);
}
function setData(data){
  fullData=data; activeFilters={}; filtered=[...fullData]; page=1; selectedRef=null;
  buildTableHead(); buildFiltersGrid(); renderActiveChips(); renderRows(); enableDataUI(true); renderDetails(null); updateExportButton();
}
function enableDataUI(enabled){
  document.getElementById("btn-clear-all").disabled=!enabled;
  document.getElementById("prev").disabled=!enabled;
  document.getElementById("next").disabled=!enabled;
  document.getElementById("perpage").disabled=!enabled;
}
function applyAllFiltersTo(data){
  return data.filter(row=>{
    for(const col in activeFilters){
      const set=activeFilters[col];
      if(set && set.size>0){
        if(!set.has(norm(row[col]))) return false;
      }
    }
    return true;
  });
}

/* ===================== UI render ===================== */
function renderActiveChips(){
  const bar=document.getElementById("active-filters"); bar.innerHTML="";
  const keys=Object.keys(activeFilters).filter(k=>activeFilters[k]&&activeFilters[k].size);
  if(!keys.length){ const span=document.createElement("span"); span.className="pill"; span.textContent="No active filters"; bar.appendChild(span); return; }
  keys.forEach(col=>{
    activeFilters[col].forEach(val=>{
      const chip=document.createElement("span"); chip.className="pill"; chip.textContent=col+": "+val+" ×";
      chip.style.cursor="pointer"; chip.title="Remove filter";
      chip.addEventListener("click",()=>{
        if(activeFilters[col]){ activeFilters[col].delete(val); if(activeFilters[col].size===0) delete activeFilters[col]; }
        filtered=applyAllFiltersTo(fullData); page=1; selectedRef=null;
        renderActiveChips(); buildFiltersGrid(); renderRows(); renderDetails(null); updateExportButton();
      });
      bar.appendChild(chip);
    });
  });
}

function lockColumn(col){
  editingColumn=col;
  document.querySelectorAll(".filter-card").forEach(card=>{
    const c=card.dataset.col, isActive=(c===col);
    card.classList.toggle("active",isActive);
    card.classList.toggle("disabled",!isActive);
    card.querySelectorAll(".filter-head input, .filter-body input.filter").forEach(el=>el.disabled=!isActive);
    if(isActive){
      const applyBtn=card.querySelector(".apply-btn");
      const anyChecked=!!card.querySelector("input.filter:checked");
      applyBtn.disabled=!anyChecked;
    }
  });
}

function buildFiltersGrid(){
  const grid=document.getElementById("filters-grid"); grid.innerHTML="";
  FILTER_COLUMNS.forEach(col=>{
    // recompute options for this column based on other filters
    const basis=(function(){
      const saved=activeFilters[col];
      if(saved) delete activeFilters[col];
      const result=applyAllFiltersTo(fullData);
      if(saved) activeFilters[col]=saved;
      return result;
    })();
    const values=uniqueSorted(basis.map(r=>r[col]));

    const card=document.createElement("div"); card.className="filter-card"; card.dataset.col=col;
    if(editingColumn===col) card.classList.add("active");
    if(editingColumn && editingColumn!==col) card.classList.add("disabled");

    const head=document.createElement("div"); head.className="filter-head";
    const title=document.createElement("b"); title.textContent=col;
    const search=document.createElement("input"); search.type="text"; search.placeholder="Search...";
    head.appendChild(title); head.appendChild(search);

    const body=document.createElement("div"); body.className="filter-body";
    function renderList(q=""){
      body.innerHTML="";
      const query=q.toLowerCase().trim();
      values.forEach(v=>{
        const vv=String(v);
        if(query && !vv.toLowerCase().includes(query)) return;
        const lab=document.createElement("label");
        const cb=document.createElement("input"); cb.type="checkbox"; cb.className="filter"; cb.dataset.col=col; cb.value=vv;
        if(activeFilters[col] && activeFilters[col].has(vv)) cb.checked=true;
        const span=document.createElement("span"); span.textContent=vv;
        lab.appendChild(cb); lab.appendChild(span); body.appendChild(lab);
      });
    }
    renderList();
    search.addEventListener("input", e=>renderList(e.target.value));

    const foot=document.createElement("div"); foot.className="filter-foot";
    const applyBtn=document.createElement("button"); applyBtn.className="primary apply-btn"; applyBtn.textContent="Apply"; applyBtn.disabled=true;
    const clearBtn=document.createElement("button"); clearBtn.className="btn"; clearBtn.textContent="Clear";
    foot.appendChild(applyBtn); foot.appendChild(clearBtn);

    if(editingColumn && editingColumn!==col){
      body.querySelectorAll("input.filter").forEach(el=>el.disabled=true);
      search.disabled=true; applyBtn.disabled=true;
    }

    function updateApplyState(){
      const anyChecked=!!body.querySelector('input.filter[type="checkbox"]:checked');
      applyBtn.disabled=!anyChecked;
    }
    updateApplyState();

    body.addEventListener("change", e=>{
      if(!e.target.matches("input.filter")) return;
      if(!editingColumn) lockColumn(col);
      updateApplyState();
    });

    applyBtn.addEventListener("click", ()=>{
      const selected=new Set();
      body.querySelectorAll('input.filter[type="checkbox"]').forEach(cb=>{ if(cb.checked) selected.add(norm(cb.value)); });
      if(selected.size>0) activeFilters[col]=selected; else delete activeFilters[col];
      filtered=applyAllFiltersTo(fullData);
      page=1; selectedRef=null;
      renderActiveChips();
      editingColumn=null;
      buildFiltersGrid();
      renderRows();
      renderDetails(null);
      updateExportButton();
    });

    clearBtn.addEventListener("click", ()=>{
      delete activeFilters[col];
      body.querySelectorAll('input.filter[type="checkbox"]').forEach(cb=>cb.checked=false);
      filtered=applyAllFiltersTo(fullData);
      page=1; selectedRef=null;
      renderActiveChips();
      editingColumn=null;
      buildFiltersGrid();
      renderRows();
      renderDetails(null);
      updateExportButton();
    });

    card.appendChild(head); card.appendChild(body); card.appendChild(foot);
    grid.appendChild(card);
  });
}

function clearAll(){
  activeFilters={};
  filtered=[...fullData];
  page=1; selectedRef=null;
  renderActiveChips();
  editingColumn=null;
  buildFiltersGrid();
  renderRows();
  renderDetails(null);
  updateExportButton();
}

function buildTableHead(){
  const tr=document.getElementById("thead-row"); tr.innerHTML="";
  DISPLAY_COLUMNS.forEach(c=>{ const th=document.createElement("th"); th.textContent=c; tr.appendChild(th); });
}

function renderRows(){
  const tbody=document.getElementById("tbody"); tbody.innerHTML="";
  const start=(page-1)*perPage, end=Math.min(start+perPage, filtered.length);
  const leftAlignSet=new Set(["Part Number","Family","Temperature"]);
  for(let i=start;i<end;i++){
    const r=filtered[i]; const tr=document.createElement("tr");
    if(selectedRef===r) tr.classList.add("selected");
    DISPLAY_COLUMNS.forEach(c=>{
      const td=document.createElement("td");
      td.textContent=norm(r[c]);
      if(leftAlignSet.has(c)) td.classList.add("left");
      tr.appendChild(td);
    });
    tr.addEventListener("click", ()=>{ selectedRef=r; renderRows(); renderDetails(r._rawOriginal||{}); updateExportButton(); });
    tbody.appendChild(tr);
  }
  document.getElementById("count-pill").textContent=filtered.length+" items";
  document.getElementById("page-info").textContent="Page "+page;
}

function renderDetails(raw){
  const box=document.getElementById("details-body");
  box.innerHTML="";
  if(!raw || Object.keys(raw).length===0){
    const div=document.createElement("div"); div.className="row";
    div.innerHTML='<span class="key">Select a row to view the full details…</span>';
    box.appendChild(div); return;
  }
  for(const key of Object.keys(raw)){
    const row=document.createElement("div"); row.className="row";
    const k=document.createElement("span"); k.className="key"; k.textContent=key+": ";
    const v=document.createElement("span"); v.className="val"; v.textContent=String(raw[key]);
    row.appendChild(k); row.appendChild(v);
    box.appendChild(row);
  }
}

function updateExportButton(){ document.getElementById("btn-export").disabled=!selectedRef; }

function exportDetailsToXLSX(){
  if(!selectedRef) return;
  const raw=selectedRef._rawOriginal || {};
  const rows=[["Field","Value"]];
  for(const key of Object.keys(raw)){ rows.push([key, String(raw[key])]); }
  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Details");
  const pn=(selectedRef["Part Number"]||"details").replace(/[^a-zA-Z0-9_\-]+/g,"_");
  XLSX.writeFile(wb, `details_${pn}.xlsx`);
}

function nextPage(){ const maxPage=Math.max(1, Math.ceil(filtered.length/perPage)); if(page<maxPage){ page++; renderRows(); } }
function prevPage(){ if(page>1){ page--; renderRows(); } }

/* ===================== Events ===================== */
document.getElementById("next").addEventListener("click", nextPage);
document.getElementById("prev").addEventListener("click", prevPage);
document.getElementById("perpage").addEventListener("change", e=>{ perPage=parseInt(e.target.value,10); page=1; renderRows(); });
document.getElementById("btn-clear-all").addEventListener("click", clearAll);
document.getElementById("btn-export").addEventListener("click", exportDetailsToXLSX);

/* ===================== Init ===================== */
(function init(){
  // Logos
  const img1=document.getElementById("logo1-img"), link1=document.getElementById("logo1-link");
  const img2=document.getElementById("logo2-img"), link2=document.getElementById("logo2-link");
  if(LOGO1_URL && LOGO1_URL.trim()!==""){ img1.src=LOGO1_URL; img1.style.display="block"; } else { img1.style.display="none"; }
  if(LOGO2_URL && LOGO2_URL.trim()!==""){ img2.src=LOGO2_URL; img2.style.display="block"; } else { img2.style.display="none"; }
  if(LOGO1_LINK && LOGO1_LINK.trim()!==""){ link1.href=LOGO1_LINK; } else { link1.removeAttribute("href"); link1.style.pointerEvents="none"; }
  if(LOGO2_LINK && LOGO2_LINK.trim()!==""){ link2.href=LOGO2_LINK; } else { link2.removeAttribute("href"); link2.style.pointerEvents="none"; }

  // Data
  enableDataUI(false);
  buildTableHead();
  autoFetchExcel();
})();
</script>
</body>
</html>
